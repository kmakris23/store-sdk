<h1 class="text-2xl font-semibold mb-4">Checkout</h1>
<div *ngIf="loading()" class="text-sm text-slate-500 mb-4">
  Loading checkout...
</div>
<div *ngIf="error()" class="text-sm text-red-600 mb-4">{{ error() }}</div>
<div
  *ngIf="success()"
  class="p-4 bg-green-100 border border-green-300 rounded mb-6"
>
  <p class="text-sm font-medium text-green-800 m-0">
    Order placed successfully!
  </p>
  <p class="text-xs text-green-700 mt-1 mb-0">Order ID: {{ orderId() }}</p>
</div>
<div class="grid gap-8 md:grid-cols-3" *ngIf="cart() as c">
  <!-- Column 1: Addresses -->
  <section class="space-y-6 md:col-span-2">
    <div class="bg-white rounded border p-4">
      <h2 class="text-sm font-semibold mb-3">Billing Address</h2>
      <div class="grid grid-cols-2 gap-3 text-xs">
        <label class="flex flex-col gap-1 col-span-1"
          >First Name
          <input
            class="border rounded px-2 py-1"
            [value]="billing().first_name"
            (input)="onBillingField('first_name', $event)"
          />
        </label>
        <label class="flex flex-col gap-1 col-span-1"
          >Last Name
          <input
            class="border rounded px-2 py-1"
            [value]="billing().last_name"
            (input)="onBillingField('last_name', $event)"
          />
        </label>
        <label class="flex flex-col gap-1 col-span-2"
          >Company
          <input
            class="border rounded px-2 py-1"
            [value]="billing().company"
            (input)="onBillingField('company', $event)"
          />
        </label>
        <label class="flex flex-col gap-1 col-span-2"
          >Address 1
          <input
            class="border rounded px-2 py-1"
            [value]="billing().address_1"
            (input)="onBillingField('address_1', $event)"
          />
        </label>
        <label class="flex flex-col gap-1 col-span-2"
          >Address 2
          <input
            class="border rounded px-2 py-1"
            [value]="billing().address_2"
            (input)="onBillingField('address_2', $event)"
          />
        </label>
        <label class="flex flex-col gap-1"
          >City
          <input
            class="border rounded px-2 py-1"
            [value]="billing().city"
            (input)="onBillingField('city', $event)"
          />
        </label>
        <label class="flex flex-col gap-1"
          >State
          <input
            class="border rounded px-2 py-1"
            [value]="billing().state"
            (input)="onBillingField('state', $event)"
          />
        </label>
        <label class="flex flex-col gap-1"
          >Postcode
          <input
            class="border rounded px-2 py-1"
            [value]="billing().postcode"
            (input)="onBillingField('postcode', $event)"
          />
        </label>
        <label class="flex flex-col gap-1"
          >Country
          <input
            class="border rounded px-2 py-1"
            [value]="billing().country"
            (input)="onBillingField('country', $event)"
          />
        </label>
        <label class="flex flex-col gap-1 col-span-2"
          >Email
          <input
            class="border rounded px-2 py-1"
            [value]="billing().email"
            (input)="onBillingField('email', $event)"
          />
        </label>
        <label class="flex flex-col gap-1 col-span-2"
          >Phone
          <input
            class="border rounded px-2 py-1"
            [value]="billing().phone"
            (input)="onBillingField('phone', $event)"
          />
        </label>
      </div>
    </div>
    <div class="bg-white rounded border p-4">
      <h2 class="text-sm font-semibold mb-3">Shipping Address</h2>
      <div class="grid grid-cols-2 gap-3 text-xs">
        <label class="flex flex-col gap-1 col-span-1"
          >First Name
          <input
            class="border rounded px-2 py-1"
            [value]="shipping().first_name"
            (input)="onShippingField('first_name', $event)"
          />
        </label>
        <label class="flex flex-col gap-1 col-span-1"
          >Last Name
          <input
            class="border rounded px-2 py-1"
            [value]="shipping().last_name"
            (input)="onShippingField('last_name', $event)"
          />
        </label>
        <label class="flex flex-col gap-1 col-span-2"
          >Company
          <input
            class="border rounded px-2 py-1"
            [value]="shipping().company"
            (input)="onShippingField('company', $event)"
          />
        </label>
        <label class="flex flex-col gap-1 col-span-2"
          >Address 1
          <input
            class="border rounded px-2 py-1"
            [value]="shipping().address_1"
            (input)="onShippingField('address_1', $event)"
          />
        </label>
        <label class="flex flex-col gap-1 col-span-2"
          >Address 2
          <input
            class="border rounded px-2 py-1"
            [value]="shipping().address_2"
            (input)="onShippingField('address_2', $event)"
          />
        </label>
        <label class="flex flex-col gap-1"
          >City
          <input
            class="border rounded px-2 py-1"
            [value]="shipping().city"
            (input)="onShippingField('city', $event)"
          />
        </label>
        <label class="flex flex-col gap-1"
          >State
          <input
            class="border rounded px-2 py-1"
            [value]="shipping().state"
            (input)="onShippingField('state', $event)"
          />
        </label>
        <label class="flex flex-col gap-1"
          >Postcode
          <input
            class="border rounded px-2 py-1"
            [value]="shipping().postcode"
            (input)="onShippingField('postcode', $event)"
          />
        </label>
        <label class="flex flex-col gap-1"
          >Country
          <input
            class="border rounded px-2 py-1"
            [value]="shipping().country"
            (input)="onShippingField('country', $event)"
          />
        </label>
        <label class="flex flex-col gap-1 col-span-2"
          >Phone
          <input
            class="border rounded px-2 py-1"
            [value]="shipping().phone"
            (input)="onShippingField('phone', $event)"
          />
        </label>
      </div>
    </div>
    <div class="bg-white rounded border p-4" *ngIf="packages().length">
      <h2 class="text-sm font-semibold mb-3">Shipping Method</h2>
      <div class="space-y-4" *ngFor="let pkg of packages()">
        <div class="text-xs font-semibold mb-1">{{ pkg.name }}</div>
        <ul class="space-y-1">
          <li *ngFor="let r of pkg.shipping_rates">
            <label class="flex items-center gap-2 text-xs cursor-pointer">
              <input
                type="radio"
                name="ship_pkg_{{ pkg.package_id }}"
                [checked]="r.selected"
                (change)="selectRate(pkg, r)"
              />
              <span>{{ r.name }} - {{ fmtMinor(r.price, r) }}</span>
            </label>
          </li>
        </ul>
      </div>
    </div>
    <div class="bg-white rounded border p-4" *ngIf="c.payment_methods?.length">
      <h2 class="text-sm font-semibold mb-3">Payment Method</h2>
      <ul class="space-y-1">
        <li *ngFor="let m of c.payment_methods">
          <label class="flex items-center gap-2 text-xs cursor-pointer">
            <input
              type="radio"
              name="payment"
              [checked]="paymentMethod()===m"
              (change)="updatePayment(m)"
            />
            <span class="capitalize">{{ prettyMethod(m) }}</span>
          </label>
        </li>
      </ul>
    </div>
  </section>
  <!-- Column 2/Right: Summary -->
  <aside class="bg-white rounded border p-4 h-max sticky top-20 space-y-4">
    <h2 class="text-sm font-semibold">Order Summary</h2>
    <ul class="divide-y text-xs">
      <li *ngFor="let item of c.items" class="py-2 flex justify-between gap-4">
        <span class="flex-1">{{ item.name }} x {{ item.quantity }}</span>
        <span>{{ item.prices?.price | price }}</span>
      </li>
    </ul>
    <div class="text-xs space-y-1 border-t pt-3">
      <div class="flex justify-between">
        <span>Subtotal</span><span>{{ c.totals?.total_items | price }}</span>
      </div>
      <div
        class="flex justify-between"
        *ngIf="c.totals?.total_shipping && c.totals?.total_shipping!=='0'"
      >
        <span>Shipping</span><span>{{ c.totals?.total_shipping | price }}</span>
      </div>
      <div
        class="flex justify-between"
        *ngIf="c.totals?.total_discount && c.totals?.total_discount!=='0'"
      >
        <span>Discount</span
        ><span>-{{ c.totals?.total_discount | price }}</span>
      </div>
      <div
        class="flex justify-between font-semibold text-sm pt-1 border-t mt-2"
      >
        <span>Total</span><span>{{ c.totals?.total_price | price }}</span>
      </div>
    </div>
    <button
      class="w-full bg-blue-600 hover:bg-blue-500 disabled:opacity-60 disabled:cursor-not-allowed text-white text-sm font-medium rounded px-4 py-2"
      (click)="placeOrder()"
      [disabled]="placing() || !c.items?.length"
    >
      {{ placing() ? 'Placing Order...' : 'Place Order' }}
    </button>
    <p class="text-[10px] text-slate-500 m-0" *ngIf="!c.items?.length">
      Your cart is empty.
    </p>
  </aside>
</div>
<p class="text-xs text-slate-500" *ngIf="!loading() && !cart()">
  Cart unavailable.
</p>
